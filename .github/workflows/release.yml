name: full-release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ðŸ§­ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: âš™ï¸ Install dependencies
        run: |
          python -m pip install --upgrade pip build twine requests pyyaml

      - name: ðŸ§± Build package
        run: python -m build

      - name: Install latest build only
        run: pip install $(ls -t dist/*.whl | head -n1)
      - name: ðŸ“¦ Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: python -m twine upload dist/*

      - name: ðŸª¶ Generate SHA256 for Homebrew
        id: brewhash
        run: echo "sha=$(sha256sum dist/*.tar.gz | cut -d ' ' -f 1)" >> $GITHUB_OUTPUT

      
    - name: Update Homebrew formula
      env:
        VERSION: ${{ github.ref_name }}
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
       run: |
          git clone https://x-access-token:${GH_TOKEN}@github.com/Mocha-sh/homebrew-mocha.git
            cd homebrew-mocha

            git config user.name "mocha-bot"
            git config user.email "bot@mocha.sh"

            sed -i "s|url \".*\"|url \"https://files.pythonhosted.org/packages/source/m/mocha-sh/mocha-sh-${VERSION}.tar.gz\"|" Formula/mocha-sh.rb
            sed -i "s|sha256 \".*\"|sha256 \"$(curl -sL https://pypi.org/pypi/mocha-sh/${VERSION}/json | jq -r '.urls[0].digests.sha256')\"|" Formula/mocha-sh.rb

            git add Formula/mocha-sh.rb
            git commit -m "Update mocha-sh to ${VERSION}" || echo "No changes to commit"
            git push origin HEAD:main

        

      - name: ðŸªŸ Update Scoop manifest
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          git clone https://github.com/Mocha-sh/scoop-mocha.git scoop
          cd scoop/bucket
          sed -i "s/\"version\":.*/\"version\": \"${VERSION}\",/" mocha-sh.json
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add mocha-sh.json
          git commit -m "Update mocha-sh to ${VERSION}"
          git push https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/Mocha-sh/scoop-mocha.git HEAD:main

      - name: ðŸ§¾ Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*
